name: CI

permissions:
  contents: read

on:
  push:
    branches: [main]
  pull_request:

jobs:
  build:
    name: ${{ matrix.os }} / ${{ matrix.crate }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        crate: [vibe-emu-core, vibe-emu-ui]
    env:
      SCCACHE_VERSION: 0.10.0

    steps:
      - uses: actions/checkout@v3

      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev libx11-dev libgtk-3-dev build-essential pkg-config libfontconfig1-dev

      - name: Cache rustup (optional)
        uses: actions/cache@v3
        with:
          path: ~/.rustup
          key: ${{ runner.os }}-rustup-${{ hashFiles('**/rust-toolchain') }}
          restore-keys: ${{ runner.os }}-rustup-

      - name: Cache cargo registry and git
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install sccache (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          try {
            $version = "$env:SCCACHE_VERSION"
            $url = "https://github.com/mozilla/sccache/releases/download/v$version/sccache-v$version-x86_64-pc-windows-msvc.zip"
            $zipPath = "$env:RUNNER_TEMP\sccache.zip"
            $outDir = "$env:RUNNER_TEMP\sccache"

            Invoke-WebRequest -Uri $url -OutFile $zipPath -ErrorAction Stop
            Expand-Archive -Path $zipPath -DestinationPath $outDir -ErrorAction Stop

            $exePath = Join-Path $outDir "sccache-v$version-x86_64-pc-windows-msvc\sccache.exe"

            if (-Not (Test-Path "$env:USERPROFILE\.cargo\bin")) {
              New-Item -ItemType Directory -Path "$env:USERPROFILE\.cargo\bin" | Out-Null
            }

            Copy-Item $exePath "$env:USERPROFILE\.cargo\bin\sccache.exe" -Force
            Write-Host "sccache installed"
          } catch {
            Write-Warning "Failed to install sccache: $($_.Exception.Message). Continuing without sccache (cache will be unavailable)."
          }


      - name: Install sccache (Linux)
        if: runner.os == 'Linux'
        run: |
          set -eo pipefail

          tmpdir="$(mktemp -d)"
          out="$tmpdir/sccache.tar.gz"
          mkdir -p "$HOME/.cargo/bin"

          version="${SCCACHE_VERSION}"
          musl_asset="sccache-v${version}-x86_64-unknown-linux-musl.tar.gz"
          gnu_asset="sccache-v${version}-x86_64-unknown-linux-gnu.tar.gz"
          url_base="https://github.com/mozilla/sccache/releases/download/v${version}"

          download() {
            local url="$1"
            echo "Downloading $url"
            # --fail makes curl return non-zero on HTTP error responses
            if ! curl -fSL "$url" -o "$out"; then
              return 1
            fi
            return 0
          }

          # Try musl first, then gnu fallback
          if ! download "${url_base}/${musl_asset}"; then
            echo "musl asset not available; trying gnu asset"
            if ! download "${url_base}/${gnu_asset}"; then
              echo "Warning: failed to download sccache release assets; continuing without sccache (cache unavailable)."
              exit 0
            fi
          fi

          # Verify tarball looks valid before extracting
          if ! tar -tzf "$out" >/dev/null 2>&1; then
            echo "Warning: downloaded sccache file is not a valid tar.gz; continuing without sccache."
            ls -l "$out"
            head -n 80 "$out" || true
            exit 0
          fi

          if ! tar -xzf "$out" -C "$tmpdir"; then
            echo "Warning: extraction failed; continuing without sccache."
            exit 0
          fi

          # Copy binary from expected locations (musl or gnu)
          if [ -x "$tmpdir/sccache-v${version}-x86_64-unknown-linux-musl/sccache" ]; then
            cp "$tmpdir/sccache-v${version}-x86_64-unknown-linux-musl/sccache" "$HOME/.cargo/bin/"
          elif [ -x "$tmpdir/sccache-v${version}-x86_64-unknown-linux-gnu/sccache" ]; then
            cp "$tmpdir/sccache-v${version}-x86_64-unknown-linux-gnu/sccache" "$HOME/.cargo/bin/"
          else
            echo "Warning: sccache binary not found in archive; continuing without sccache."
            exit 0
          fi

          chmod +x "$HOME/.cargo/bin/sccache"
          echo "sccache installed"

      - name: Set RUSTC_WRAPPER
        run: echo "RUSTC_WRAPPER=sccache" >> $GITHUB_ENV

      - name: Cache sccache
        uses: actions/cache@v3
        with:
          path: ~/.cache/sccache
          key: ${{ runner.os }}-sccache-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-sccache-

      - name: Cache target (debug)
        uses: actions/cache@v3
        with:
          path: target/debug
          key: ${{ runner.os }}-target-debug-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-target-debug-

      - name: Check formatting
        if: matrix.crate == 'vibe-emu-core' && runner.os == 'Linux'
        run: cargo fmt --all -- --check

      - name: Lint
        run: cargo clippy -p ${{ matrix.crate }} --all-targets -- -D warnings

      - name: Test debug
        run: cargo test --verbose -p ${{ matrix.crate }}

      - name: Cache target (release)
        uses: actions/cache@v3
        with:
          path: target/release
          key: ${{ runner.os }}-target-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-target-release-

      - name: Test release
        run: cargo test --release --verbose -p ${{ matrix.crate }}

  cargo-deny:
    name: cargo deny
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-deny
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny

      - name: Run cargo deny
        run: cargo deny --locked check

  license-report:
    name: license diff
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-about
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-about

      - name: Ensure THIRD_PARTY_LICENSES.html is current
        shell: pwsh
        run: |
          $output = Join-Path $env:RUNNER_TEMP "licenses.html"
          cargo about generate --config about.toml about.hbs -o $output
          git diff --no-index -- THIRD_PARTY_LICENSES.html $output
